<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evalúa tu Idea de Negocio</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for dynamic graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Gris muy suave */
            color: #334155; /* Gris oscuro para texto principal */
        }
        .container {
            max-width: 800px;
        }
        .form-block {
            background-color: #f9fcff; /* Toque azul clarito */
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.03); /* Sombra ligeramente ajustada */
            padding: 2.5rem;
            margin-bottom: 2rem;
        }
        /* Specific styling for the welcome block */
        #block-1 {
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%); /* Light blue gradient */
            padding: 4rem 2.5rem; /* More vertical padding */
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: fadeInScale 0.8s ease-out; /* Subtle animation */
        }
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            border: 1px solid #cbd5e1; /* Gris claro */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #60a5fa; /* Azul claro */
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3); /* Sombra azul suave */
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .btn-primary {
            background-color: #3b82f6; /* Azul vibrante */
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Azul más oscuro */
            transform: translateY(-1px);
        }
        /* Enhanced button styling for the welcome screen */
        #block-1 .btn-primary {
            padding: 1rem 2.5rem; /* Larger padding */
            font-size: 1.25rem; /* Larger font */
            border-radius: 1rem; /* More rounded */
            background: linear-gradient(45deg, #3b82f6, #60a5fa); /* Gradient for primary button */
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3); /* Subtle shadow */
        }
        #block-1 .btn-primary:hover {
            background: linear-gradient(45deg, #2563eb, #3b82f6);
            box-shadow: 0 7px 20px rgba(37, 99, 235, 0.4);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #e2e8f0; /* Gris claro */
            color: #475569; /* Gris oscuro */
        }
        .btn-secondary:hover {
            background-color: #cbd5e1; /* Gris un poco más oscuro */
            transform: translateY(-1px);
        }
        .option-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            border: 1px solid #cbd5e1;
            background-color: #f8fafc;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            color: #475569;
        }
        .option-button.selected {
            background-color: #dbeafe; /* Azul claro muy suave */
            border-color: #60a5fa; /* Azul claro */
            color: #1e40af; /* Azul oscuro */
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
        }
        .option-button:hover:not(.selected) {
            background-color: #eff6ff; /* Azul muy claro al pasar el ratón */
            border-color: #93c5fd;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .checkbox-item input[type="checkbox"] {
            margin-right: 0.75rem;
            width: auto; /* Override full width for checkboxes */
        }
        .checkbox-item input[type="number"] {
            width: 120px; /* Fixed width for number input next to checkbox */
            margin-left: 1rem;
        }
        .hidden {
            display: none;
        }
        .score-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #3b82f6;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .risk-level {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .risk-low { color: #22c55e; } /* Green */
        .risk-medium { color: #facc15; } /* Yellow */
        .risk-high { color: #ef4444; } /* Red */

        .product-entry {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background-color: #fdfdfe;
            position: relative;
        }
        .product-entry .remove-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .product-entry .remove-btn:hover {
            background-color: #dc2626;
        }

        /* Tooltip styles */
        .tooltip-container {
            position: relative;
        }

        .info-icon {
            position: absolute;
            top: 0.75rem; /* Ajusta según sea necesario para el padding del contenedor */
            right: 0.75rem; /* Ajusta según sea necesario para el padding del contenedor */
            width: 20px;
            height: 20px;
            background-color: #a0aec0; /* Gris medio */
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: help; /* Cambia el cursor para indicar que es informativo */
            z-index: 10;
            transition: background-color 0.2s ease-in-out;
        }

        .info-icon:hover {
            background-color: #60a5fa; /* Azul al pasar el ratón */
        }

        .info-icon .tooltip-text {
            visibility: hidden;
            opacity: 0;
            width: 200px; /* Ancho del tooltip */
            background-color: #334155; /* Fondo oscuro */
            color: #fff;
            text-align: left; /* Alineado a la izquierda para mejor lectura de listas */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem; /* Más padding para el contenido */
            position: absolute;
            z-index: 100;
            bottom: 125%; /* Posiciona encima del icono */
            left: 50%;
            transform: translateX(-50%); /* Centra el tooltip */
            transition: opacity 0.3s, visibility 0.3s;
            font-size: 0.875rem;
            line-height: 1.4; /* Espaciado de línea para legibilidad */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .info-icon .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%; /* En la parte inferior */
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #334155 transparent transparent transparent; /* Triángulo apuntando hacia abajo */
        }

        .info-icon:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Estilos para los nuevos campos de gasto personalizado */
        .custom-expense-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            gap: 0.5rem; /* Espacio entre los elementos del gasto personalizado */
        }
        .custom-expense-item input[type="text"] {
            flex-grow: 1; /* Permite que el campo de texto ocupe el espacio disponible */
        }
        .custom-expense-item input[type="number"] {
            width: 120px; /* Ancho fijo para el campo de cantidad */
            flex-shrink: 0; /* Evita que se encoja */
        }
        .remove-custom-expense-btn {
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0; /* Evita que se encoja */
        }
        .remove-custom-expense-btn:hover {
            background-color: #dc2626;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #f9fcff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.visible .modal-content {
            transform: translateY(0);
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #60a5fa;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close-btn:hover {
            color: #3b82f6;
        }
        .modal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        .modal-table th, .modal-table td {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            text-align: left;
        }
        .modal-table th {
            background-color: #e0f2fe;
            font-weight: 600;
            color: #1e40af;
        }
        .modal-table tr:nth-child(even) {
            background-color: #f0f8ff;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <main class="flex-grow flex items-center justify-center py-12 px-4">
        <div class="container mx-auto">

            <!-- Bloque 1 – Bienvenida -->
            <div id="block-1" class="form-block text-center">
                <!-- Icono SVG de un chip/circuito para AI/tecnología -->
                <svg class="mx-auto mb-6 text-blue-600" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="3" width="20" height="18" rx="2" ry="2"></rect>
                    <line x1="8" y1="2" x2="8" y2="22"></line>
                    <line x1="16" y1="2" x2="16" y2="22"></line>
                    <line x1="2" y1="8" x2="22" y2="8"></line>
                    <line x1="2" y1="16" x2="22" y2="16"></line>
                </svg>
                <h1 class="text-4xl font-bold mb-4 text-gray-800">Evalúa tu idea de negocio en 5 pasos</h1>
                <p class="text-lg text-gray-600 mb-8">Descubre si tiene potencial, cuánto necesitas invertir y qué mejorar.</p>
                <button class="btn btn-primary" onclick="nextBlock()">Empezar evaluación</button>
            </div>

            <!-- Bloque 2 – Tu idea en pocas palabras -->
            <div id="block-2" class="form-block hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Tu idea en pocas palabras</h2>
                <div class="mb-6">
                    <label for="projectName" class="block text-gray-700 text-sm font-medium mb-2">Nombre del proyecto</label>
                    <input type="text" id="projectName" name="projectName" placeholder="Ej: Café con Causa">
                </div>
                <div class="mb-6">
                    <label for="problemSolved" class="block text-gray-700 text-sm font-medium mb-2">¿Qué problema resuelve?</label>
                    <textarea id="problemSolved" name="problemSolved" rows="4" placeholder="Describe brevemente el problema que aborda tu negocio."></textarea>
                </div>
                <div class="mb-6">
                    <label for="sector" class="block text-gray-700 text-sm font-medium mb-2">Sector principal</label>
                    <select id="sector" name="sector">
                        <option value="">Selecciona un sector</option>
                        <option value="alimentacion">Alimentación</option>
                        <option value="moda">Moda</option>
                        <option value="tecnologia">Tecnología</option>
                        <option value="servicios_personales">Servicios personales</option>
                        <option value="educacion">Educación / Formación</option>
                        <option value="turismo">Turismo y hostelería</option>
                        <option value="salud">Salud y bienestar</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">¿Qué vas a vender?</label>
                    <div class="flex flex-wrap gap-3">
                        <button type="button" class="option-button" data-name="sellType" data-value="productos" onclick="selectOption(this, 'sellType')">Productos</button>
                        <button type="button" class="option-button" data-name="sellType" data-value="servicios" onclick="selectOption(this, 'sellType')">Servicios</button>
                        <button type="button" class="option-button" data-name="sellType" data-value="ambos" onclick="selectOption(this, 'sellType')">Ambos</button>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">¿Dónde vas a vender?</label>
                    <div class="flex flex-wrap gap-3">
                        <button type="button" class="option-button" data-name="sellLocation" data-value="fisica" onclick="selectOption(this, 'sellLocation')">Tienda física</button>
                        <button type="button" class="option-button" data-name="sellLocation" data-value="online" onclick="selectOption(this, 'sellLocation')">Online</button>
                        <button type="button" class="option-button" data-name="sellLocation" data-value="ambas" onclick="selectOption(this, 'sellLocation')">Ambas</button>
                        <button type="button" class="option-button" data-name="sellLocation" data-value="no_se" onclick="selectOption(this, 'sellLocation')">No lo sé aún</button>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="differentiation" class="block text-gray-700 text-sm font-medium mb-2">¿Qué te hace diferente?</label>
                    <textarea id="differentiation" name="differentiation" rows="4" placeholder="Describe tu propuesta de valor única."></textarea>
                </div>
                <div class="flex justify-between mt-8">
                    <button class="btn btn-secondary" onclick="prevBlock()">Anterior</button>
                    <button class="btn btn-primary" onclick="nextBlock()">Siguiente</button>
                </div>
            </div>

            <!-- Bloque 3 – Estructura del negocio -->
            <div id="block-3" class="form-block hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Estructura del negocio</h2>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">¿Necesitarás local, almacén o taller?</label>
                    <div class="flex flex-wrap gap-3">
                        <button type="button" class="option-button" data-name="needsSpace" data-value="si" onclick="selectOption(this, 'needsSpace')">Sí</button>
                        <button type="button" class="option-button" data-name="needsSpace" data-value="no" onclick="selectOption(this, 'needsSpace')">No</button>
                    </div>
                </div>
                <!-- Pregunta de espacio: oculta por defecto y controlada por JS -->
                <div id="spaceTypeQuestion" class="mb-6 hidden">
                    <label for="spaceType" class="block text-gray-700 text-sm font-medium mb-2">¿Alquilarás o comprarás el espacio?</label>
                    <select id="spaceType" name="spaceType">
                        <option value="">Selecciona una opción</option>
                        <option value="alquiler">Alquiler</option>
                        <option value="compra">Compra</option>
                        <option value="no_se">Aún no lo sé</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="hoursPerDay" class="block text-gray-700 text-sm font-medium mb-2">¿Cuántas horas al día estará abierto el negocio?</label>
                    <input type="number" id="hoursPerDay" name="hoursPerDay" min="0" placeholder="Ej: 8">
                </div>
                <div class="mb-6">
                    <label for="daysPerWeek" class="block text-gray-700 text-sm font-medium mb-2">¿Cuántos días a la semana estará abierto?</label>
                    <input type="number" id="daysPerWeek" name="daysPerWeek" min="0" max="7" placeholder="Ej: 5">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">¿Tendrás empleados en la primera fase?</label>
                    <div class="flex flex-wrap gap-3">
                        <button type="button" class="option-button" data-name="hasEmployees" data-value="si" onclick="selectOption(this, 'hasEmployees')">Sí</button>
                        <button type="button" class="option-button" data-name="hasEmployees" data-value="no" onclick="selectOption(this, 'hasEmployees')">No</button>
                        <button type="button" class="option-button" data-name="hasEmployees" data-value="no_se" onclick="selectOption(this, 'hasEmployees')">No lo sé aún</button>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="canDelegate" class="block text-gray-700 text-sm font-medium mb-2">¿Podrás delegar las ventas u operaciones?</label>
                    <select id="canDelegate" name="canDelegate">
                        <option value="">Selecciona una opción</option>
                        <option value="totalmente">Sí, totalmente</option>
                        <option value="parcialmente">Parcialmente</option>
                        <option value="no_yo">No, lo haré todo yo</option>
                    </select>
                </div>
                <div class="flex justify-between mt-8">
                    <button class="btn btn-secondary" onclick="prevBlock()">Anterior</button>
                    <button class="btn btn-primary" onclick="nextBlock()">Siguiente</button>
                </div>
            </div>

            <!-- Bloque 4 – Costes e inversión inicial -->
            <div id="block-4" class="form-block hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Costes e inversión inicial</h2>
                <div class="mb-6">
                    <label for="initialInvestment" class="block text-gray-700 text-sm font-medium mb-2">¿Qué inversión inicial estimas que necesitas?</label>
                    <select id="initialInvestment" name="initialInvestment">
                        <option value="">Selecciona una opción</option>
                        <option value="menos_5k">Menos de 5.000 €</option>
                        <option value="5k_20k">Entre 5.000 € y 20.000 €</option>
                        <option value="mas_20k">Más de 20.000 €</option>
                        <option value="no_se">No lo sé aún</option>
                    </select>
                </div>

                <!-- Nueva sección para la forma jurídica -->
                <div class="mb-6 tooltip-container">
                    <label class="block text-gray-700 text-sm font-medium mb-2">¿Cuál será tu forma jurídica inicial?</label>
                    <div class="flex flex-wrap gap-3">
                        <button type="button" class="option-button" data-name="legalForm" data-value="autonomo" onclick="selectOption(this, 'legalForm'); updateLegalFormCostsInUI();">Autónomo</button>
                        <button type="button" class="option-button" data-name="legalForm" data-value="sl" onclick="selectOption(this, 'legalForm'); updateLegalFormCostsInUI();">Sociedad Limitada (SL)</button>
                    </div>
                    <!-- Info icon to open the modal -->
                    <div class="info-icon" onclick="openLegalFormModal()">i</div>
                </div>

                <div id="autonomoTypeQuestion" class="mb-6 hidden">
                    <label class="block text-gray-700 text-sm font-medium mb-2">
                        ¿Qué tipo de autónomo serás?
                        <span class="info-icon-inline tooltip-container">i
                            <span class="tooltip-text">
                                **Tarifa Plana:** Nuevo autónomo o no haber sido autónomo en los últimos 2 años (3 si te beneficiaste antes).
                            </span>
                        </span>
                    </label>
                    <div class="flex flex-wrap gap-3">
                        <button type="button" class="option-button" data-name="autonomoType" data-value="tarifa_plana" onclick="selectOption(this, 'autonomoType'); updateLegalFormCostsInUI();">Autónomo (tarifa plana)</button>
                        <button type="button" class="option-button" data-name="autonomoType" data-value="normal" onclick="selectOption(this, 'autonomoType'); updateLegalFormCostsInUI();">Autónomo (normal)</button>
                    </div>
                </div>
                <!-- Fin de la nueva sección para la forma jurídica -->

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">¿Qué gastos iniciales tendrás?</label>
                    <div id="initialExpensesContainer">
                        <!-- New: Coste de constitución -->
                        <div class="checkbox-item">
                            <input type="checkbox" id="expConstitucion" name="initialExpenses" value="Coste de constitución" onchange="toggleExpenseInput(this, 'expConstitucionAmount')">
                            <label for="expConstitucion" class="text-gray-700">Coste de constitución</label>
                            <input type="number" id="expConstitucionAmount" name="expConstitucionAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                        <!-- Checkboxes and inputs for initial expenses -->
                        <div class="checkbox-item">
                            <input type="checkbox" id="expLocal" name="initialExpenses" value="Alquiler o compra del local" onchange="toggleExpenseInput(this, 'expLocalAmount')">
                            <label for="expLocal" class="text-gray-700">Alquiler o compra del local</label>
                            <input type="number" id="expLocalAmount" name="expLocalAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="expLicencias" name="initialExpenses" value="Licencias o permisos" onchange="toggleExpenseInput(this, 'expLicenciasAmount')">
                            <label for="expLicencias" class="text-gray-700">Licencias o permisos</label>
                            <input type="number" id="expLicenciasAmount" name="expLicenciasAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="expReformas" name="initialExpenses" value="Reformas o adecuación" onchange="toggleExpenseInput(this, 'expReformasAmount')">
                            <label for="expReformas" class="text-gray-700">Reformas o adecuación</label>
                            <input type="number" id="expReformasAmount" name="expReformasAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="expEquipamiento" name="initialExpenses" value="Equipamiento informático o herramientas" onchange="toggleExpenseInput(this, 'expEquipamientoAmount')">
                            <label for="expEquipamiento" class="text-gray-700">Equipamiento informático o herramientas</label>
                            <input type="number" id="expEquipamientoAmount" name="expEquipamientoAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="expMobiliario" name="initialExpenses" value="Mobiliario" onchange="toggleExpenseInput(this, 'expMobiliarioAmount')">
                            <label for="expMobiliario" class="text-gray-700">Mobiliario</label>
                            <input type="number" id="expMobiliarioAmount" name="expMobiliarioAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="expVehiculo" name="initialExpenses" value="Vehículo o transporte" onchange="toggleExpenseInput(this, 'expVehiculoAmount')">
                            <label for="expVehiculo" class="text-gray-700">Vehículo o transporte</label>
                            <input type="number" id="expVehiculoAmount" name="expVehiculoAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="expPublicidad" name="initialExpenses" value="Publicidad o marketing de apertura" onchange="toggleExpenseInput(this, 'expPublicidadAmount')">
                            <label for="expPublicidad" class="text-gray-700">Publicidad o marketing de apertura</label>
                            <input type="number" id="expPublicidadAmount" name="expPublicidadAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="expStock" name="initialExpenses" value="Stock inicial" onchange="toggleExpenseInput(this, 'expStockAmount')">
                            <label for="expStock" class="text-gray-700">Stock inicial</label>
                            <input type="number" id="expStockAmount" name="expStockAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary mt-2 text-sm" onclick="addCustomExpense('initialExpensesContainer', 'initial')">Añadir gasto personalizado</button>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">¿Qué gastos fijos mensuales estimas?</label>
                    <div id="monthlyExpensesContainer">
                        <!-- New: Cuota Seguridad Social -->
                        <div class="checkbox-item">
                            <input type="checkbox" id="monthlySeguridadSocial" name="monthlyExpenses" value="Cuota Seguridad Social" onchange="toggleExpenseInput(this, 'monthlySeguridadSocialAmount')">
                            <label for="monthlySeguridadSocial" class="text-gray-700">Cuota Seguridad Social</label>
                            <input type="number" id="monthlySeguridadSocialAmount" name="monthlySeguridadSocialAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                        <!-- New: Gestoría / Asesoría -->
                        <div class="checkbox-item">
                            <input type="checkbox" id="monthlyGestoria" name="monthlyExpenses" value="Gestoría / Asesoría" onchange="toggleExpenseInput(this, 'monthlyGestoriaAmount')">
                            <label for="monthlyGestoria" class="text-gray-700">Gestoría / Asesoría</label>
                            <input type="number" id="monthlyGestoriaAmount" name="monthlyGestoriaAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                        <!-- Checkboxes and inputs for monthly expenses -->
                        <div class="checkbox-item">
                            <input type="checkbox" id="monthlyAlquiler" name="monthlyExpenses" value="Alquiler" onchange="toggleExpenseInput(this, 'monthlyAlquilerAmount')">
                            <label for="monthlyAlquiler" class="text-gray-700">Alquiler</label>
                            <input type="number" id="monthlyAlquilerAmount" name="monthlyAlquilerAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="monthlyNominas" name="monthlyExpenses" value="Nóminas" onchange="toggleExpenseInput(this, 'monthlyNominasAmount')">
                            <label for="monthlyNominas" class="text-gray-700">Nóminas</label>
                            <input type="number" id="monthlyNominasAmount" name="monthlyNominasAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="monthlySuministros" name="monthlyExpenses" value="Luz, agua, internet" onchange="toggleExpenseInput(this, 'monthlySuministrosAmount')">
                            <label for="monthlySuministros" class="text-gray-700">Luz, agua, internet</label>
                            <input type="number" id="monthlySuministrosAmount" name="monthlySuministrosAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="monthlySeguros" name="monthlyExpenses" value="Seguros" onchange="toggleExpenseInput(this, 'monthlySegurosAmount')">
                            <label for="monthlySeguros" class="text-gray-700">Seguros</label>
                            <input type="number" id="monthlySegurosAmount" name="monthlySegurosAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="monthlyPublicidad" name="monthlyExpenses" value="Publicidad / redes" onchange="toggleExpenseInput(this, 'monthlyPublicidadAmount')">
                            <label for="monthlyPublicidad" class="text-gray-700">Publicidad / redes</label>
                            <input type="number" id="monthlyPublicidadAmount" name="monthlyPublicidadAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="monthlyComisiones" name="monthlyExpenses" value="Comisiones de pago o plataformas online" onchange="toggleExpenseInput(this, 'monthlyComisionesAmount')">
                            <label for="monthlyComisiones" class="text-gray-700">Comisiones de pago o plataformas online</label>
                            <input type="number" id="monthlyComisionesAmount" name="monthlyComisionesAmount" class="hidden" placeholder="Cantidad (€)">
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary mt-2 text-sm" onclick="addCustomExpense('monthlyExpensesContainer', 'monthly')">Añadir gasto personalizado</button>
                </div>

                <div class="flex justify-between mt-8">
                    <button class="btn btn-secondary" onclick="prevBlock()">Anterior</button>
                    <button class="btn btn-primary" onclick="nextBlock()">Siguiente</button>
                </div>
            </div>

            <!-- Bloque 5 – Ingresos esperados (Múltiples Productos/Servicios) -->
            <div id="block-5" class="form-block hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Ingresos esperados</h2>
                <div id="productsServicesContainer">
                    <!-- Product/Service entries will be added here dynamically -->
                    <div class="product-entry">
                        <button type="button" class="remove-btn" onclick="removeProductEntry(this)">X</button>
                        <h4 class="text-lg font-medium mb-4 text-gray-800">Producto/Servicio 1</h4>
                        <div class="mb-4 tooltip-container">
                            <label class="block text-gray-700 text-sm font-medium mb-2">Nombre del Producto/Servicio</label>
                            <input type="text" class="product-name" placeholder="Ej: Café Latte">
                        </div>
                        <div class="mb-4 tooltip-container">
                            <label class="block text-gray-700 text-sm font-medium mb-2">Precio medio de venta (€)</label>
                            <input type="number" class="product-avg-price" min="0" step="0.01" placeholder="Ej: 3.50">
                            <div class="info-icon">i<span class="tooltip-text">Precio promedio al que esperas vender cada unidad de tu producto o servicio.</span></div>
                        </div>
                        <div class="mb-4 tooltip-container">
                            <label class="block text-gray-700 text-sm font-medium mb-2">Coste variable por unidad (€)</label>
                            <input type="number" class="product-variable-cost" min="0" step="0.01" placeholder="Ej: 1.00">
                            <div class="info-icon">i<span class="tooltip-text">Coste directo asociado a la producción o entrega de cada unidad vendida (ej. materiales, comisiones por venta).</span></div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-medium mb-2">Unidades esperadas a vender al mes</label>
                            <input type="number" class="product-units-per-month" min="0" placeholder="Ej: 300">
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary mt-4" onclick="addProductEntry()">Añadir otro Producto/Servicio</button>

                <div class="mb-6 mt-8">
                    <!-- Moved button above textbox -->
                    <button type="button" class="btn btn-secondary mt-2 text-sm" onclick="calculateTotalRevenue()">Calcular Facturación Total</button>
                    <label class="block text-gray-700 text-sm font-medium mb-2 mt-2">Facturación mensual estimada total (€)</label>
                    <input type="number" id="estimatedTotalRevenue" name="estimatedTotalRevenue" min="0" step="0.01" placeholder="Calculado automáticamente" readonly>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">¿Has hecho alguna prueba real de ventas o cobros?</label>
                    <div class="flex flex-wrap gap-3">
                        <button type="button" class="option-button" data-name="salesTest" data-value="si" onclick="selectOption(this, 'salesTest')">Sí</button>
                        <button type="button" class="option-button" data-name="salesTest" data-value="no" onclick="selectOption(this, 'salesTest')">No</button>
                        <button type="button" class="option-button" data-name="salesTest" data-value="en_proceso" onclick="selectOption(this, 'salesTest')">En proceso</button>
                    </div>
                </div>
                <div class="flex justify-between mt-8">
                    <button class="btn btn-secondary" onclick="prevBlock()">Anterior</button>
                    <button class="btn btn-primary" onclick="nextBlock()">Siguiente</button>
                </div>
            </div>

            <!-- Bloque 6 – Estado del proyecto y riesgos -->
            <div id="block-6" class="form-block hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Estado del proyecto y riesgos</h2>
                <div class="mb-6">
                    <label for="projectStatus" class="block text-gray-700 text-sm font-medium mb-2">¿En qué estado está tu idea?</label>
                    <select id="projectStatus" name="projectStatus">
                        <option value="">Selecciona una opción</option>
                        <option value="solo_idea">Solo una idea por ahora</option>
                        <option value="desarrollando">Estoy desarrollándola</option>
                        <option value="clientes_ventas">Ya tengo clientes o ventas</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">¿Qué riesgos detectas?</label>
                    <div id="risksContainer">
                        <div class="checkbox-item">
                            <input type="checkbox" id="riskDemanda" name="risks" value="Falta de demanda">
                            <label for="riskDemanda" class="text-gray-700">Falta de demanda</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="riskLegal" name="risks" value="Dificultades legales o burocráticas">
                            <label for="riskLegal" class="text-gray-700">Dificultades legales o burocráticas</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="riskCompetencia" name="risks" value="Mucha competencia">
                            <label for="riskCompetencia" class="text-gray-700">Mucha competencia</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="riskFinanciacion" name="risks" value="Dificultades para conseguir financiación">
                            <label for="riskFinanciacion" class="text-gray-700">Dificultades para conseguir financiación</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="riskTiempoEquipo" name="risks" value="Falta de tiempo o equipo">
                            <label for="riskTiempoEquipo" class="text-gray-700">Falta de tiempo o equipo</label>
                        </div>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">¿Tienes financiación asegurada?</label>
                    <div class="flex flex-wrap gap-3">
                        <button type="button" class="option-button" data-name="fundingSecured" data-value="si" onclick="selectOption(this, 'fundingSecured')">Sí</button>
                        <button type="button" class="option-button" data-name="fundingSecured" data-value="no" onclick="selectOption(this, 'fundingSecured')">No</button>
                        <button type="button" class="option-button" data-name="fundingSecured" data-value="no_se" onclick="selectOption(this, 'fundingSecured')">No lo sé aún</button>
                    </div>
                </div>
                <div class="flex justify-between mt-8">
                    <button class="btn btn-secondary" onclick="prevBlock()">Anterior</button>
                    <button class="btn btn-primary" onclick="submitForm()">Finalizar Evaluación</button>
                </div>
            </div>

            <!-- Bloque 7 – Resultados -->
            <div id="block-7" class="form-block hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">Resultados de tu Evaluación</h2>

                <!-- 1. Indicadores clave visuales -->
                <div class="mb-8">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700">Indicadores Clave</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-4 bg-blue-50 rounded-lg shadow-sm relative tooltip-container">
                            <p class="text-sm text-gray-600">Rentabilidad Anual Estimada</p>
                            <p id="resultProfitability" class="text-xl font-bold text-blue-700">--</p>
                            <div class="info-icon" data-tooltip="Beneficio (o pérdida) esperado anualmente después de cubrir costes fijos y variables.">i<span class="tooltip-text">Beneficio (o pérdida) esperado anualmente después de cubrir costes fijos y variables.</span></div>
                        </div>
                        <div class="p-4 bg-green-50 rounded-lg shadow-sm relative tooltip-container">
                            <p class="text-sm text-gray-600">Inversión Inicial Total</p>
                            <p id="resultInitialInvestment" class="text-xl font-bold text-green-700">--</p>
                            <div class="info-icon" data-tooltip="Suma total de los gastos necesarios para iniciar el negocio.">i<span class="tooltip-text">Suma total de los gastos necesarios para iniciar el negocio.</span></div>
                        </div>
                        <div class="p-4 bg-red-50 rounded-lg shadow-sm relative tooltip-container">
                            <p class="text-sm text-gray-600">Costes Fijos Anuales</p>
                            <p id="resultAnnualFixedCosts" class="text-xl font-bold text-red-700">--</p>
                            <div class="info-icon" data-tooltip="Gastos recurrentes anuales que no varían con el volumen de ventas (ej. alquiler, salarios).">i<span class="tooltip-text">Gastos recurrentes anuales que no varían con el volumen de ventas (ej. alquiler, salarios).</span></div>
                        </div>
                        <div class="p-4 bg-purple-50 rounded-lg shadow-sm relative tooltip-container">
                            <p class="text-sm text-gray-600">Volumen de Ventas (Unidades/Año)</p>
                            <p id="resultSalesVolume" class="text-xl font-bold text-purple-700">--</p>
                            <div class="info-icon" data-tooltip="Número total de unidades de productos/servicios que se espera vender en un año.">i<span class="tooltip-text">Número total de unidades de productos/servicios que se espera vender en un año.</span></div>
                        </div>
                        <div class="p-4 bg-yellow-50 rounded-lg shadow-sm relative tooltip-container">
                            <p class="text-sm text-gray-600">Punto de Equilibrio (Unidades)</p>
                            <p id="resultBreakEvenUnits" class="text-xl font-bold text-yellow-700">--</p>
                            <div class="info-icon" data-tooltip="Número de unidades que necesitas vender para cubrir todos tus costes (fijos y variables).">i<span class="tooltip-text">Número de unidades que necesitas vender para cubrir todos tus costes (fijos y variables).</span></div>
                        </div>
                        <div class="p-4 bg-teal-50 rounded-lg shadow-sm relative tooltip-container">
                            <p class="text-sm text-gray-600">Margen de Contribución Total (Mensual)</p>
                            <p id="resultTotalContributionMargin" class="text-xl font-bold text-teal-700">--</p>
                            <div class="info-icon" data-tooltip="Dinero que queda de las ventas mensuales después de cubrir los costes variables, disponible para cubrir costes fijos y generar beneficio.">i<span class="tooltip-text">Dinero que queda de las ventas mensuales después de cubrir los costes variables, disponible para cubrir costes fijos y generar beneficio.</span></div>
                        </div>
                        <div class="p-4 bg-orange-50 rounded-lg shadow-sm relative tooltip-container">
                            <p class="text-sm text-gray-600">ROI (Retorno de la Inversión)</p>
                            <p id="resultROI" class="text-xl font-bold text-orange-700">--</p>
                            <div class="info-icon" data-tooltip="Porcentaje de beneficio obtenido en relación con la inversión inicial.">i<span class="tooltip-text">Porcentaje de beneficio obtenido en relación con la inversión inicial.</span></div>
                        </div>
                        <div class="p-4 bg-lime-50 rounded-lg shadow-sm relative tooltip-container">
                            <p class="text-sm text-gray-600">Periodo de Recuperación (Payback)</p>
                            <p id="resultPaybackPeriod" class="text-xl font-bold text-lime-700">--</p>
                            <div class="info-icon" data-tooltip="Tiempo estimado (en años) que tardarás en recuperar la inversión inicial con la rentabilidad anual.">i<span class="tooltip-text">Tiempo estimado (en años) que tardarás en recuperar la inversión inicial con la rentabilidad anual.</span></div>
                        </div>
                        <div class="p-4 bg-gray-100 rounded-lg shadow-sm text-center relative tooltip-container">
                            <p class="text-sm text-gray-600">Riesgo de la Idea</p>
                            <p id="resultRisk" class="risk-level">--</p>
                            <div class="info-icon" data-tooltip="Nivel de riesgo asociado a la idea de negocio según los factores identificados.">i<span class="tooltip-text">Nivel de riesgo asociado a la idea de negocio según los factores identificados.</span></div>
                        </div>
                        <div class="p-4 bg-gray-100 rounded-lg shadow-sm text-center relative tooltip-container">
                            <p class="text-sm text-gray-600">Score de Viabilidad</p>
                            <p id="resultViabilityScore" class="score-display">--</p>
                            <div class="info-icon">i<span class="tooltip-text">Puntuación general de la viabilidad de la idea, calculada según los datos que has introducido.</span></div>
                        </div>
                    </div>
                </div>

                <!-- 2. Sección de observaciones -->
                <div class="mb-8">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700">Observaciones</h3>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                        <p class="text-gray-700 mb-3" id="observationsSummary">
                            <!-- Summary will be injected here -->
                        </p>
                        <p class="text-gray-700 font-medium" id="observationsAdvice">
                            <!-- Advice will be injected here -->
                        </p>
                    </div>
                </div>

                <!-- 3. Gráficos dinámicos -->
                <div class="mb-8">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700">Gráficos Clave</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <canvas id="breakEvenChart"></canvas>
                            <p class="text-center text-sm text-gray-500 mt-2">Punto de Equilibrio Anual vs. Ventas Esperadas Anuales</p>
                        </div>
                        <div>
                            <canvas id="contributionMarginChart"></canvas>
                            <p class="text-center text-sm text-gray-500 mt-2">Margen de Contribución por Producto/Servicio</p>
                        </div>
                        <div>
                            <canvas id="riskProfitabilityMatrix"></canvas>
                            <p class="text-center text-sm text-gray-500 mt-2">Matriz Riesgo vs. Rentabilidad Anual</p>
                        </div>
                        <div>
                            <canvas id="costDistributionChart"></canvas>
                            <p class="text-center text-sm text-gray-500 mt-2">Distribución de Gastos Fijos Mensuales</p>
                        </div>
                        <div>
                            <canvas id="operatingCostChart"></canvas>
                            <p class="text-center text-sm text-gray-500 mt-2">Coste vs. Ingreso de Operación por Día</p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center mt-8">
                    <button class="btn btn-primary" onclick="resetForm()">Empezar nueva evaluación</button>
                </div>
            </div>

        </div>
    </main>

    <footer class="py-6 text-center text-gray-400 text-sm">
        © Gari Peña. Todos los derechos reservados.
    </footer>

    <!-- Legal Form Info Modal -->
    <div id="legalFormModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeLegalFormModal()">&times;</button>
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Costes de Forma Jurídica</h3>
            <table class="modal-table">
                <thead>
                    <tr>
                        <th>Concepto</th>
                        <th>Autónomo (nuevo)</th>
                        <th>Autónomo (normal)</th>
                        <th>Sociedad Limitada (SL)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Cuota Seguridad Social</td>
                        <td>80€/mes (tarifa plana: nuevo autónomo o no haber sido autónomo en los últimos 2 años (3 si te beneficiaste antes))</td>
                        <td>Desde 230€/mes</td>
                        <td>310-400€/mes (autónomo societario)</td>
                    </tr>
                    <tr>
                        <td>Gestoría / Asesoría</td>
                        <td>30 - 100€/mes</td>
                        <td>30 - 100€/mes</td>
                        <td>100 - 300€/mes</td>
                    </tr>
                    <tr>
                        <td>Impuestos (IRPF/IVA/IS)</td>
                        <td>Trimestrales</td>
                        <td>Trimestrales</td>
                        <td>Trimestrales / Anuales</td>
                    </tr>
                    <tr>
                        <td>Coste de constitución</td>
                        <td>0€</td>
                        <td>0€</td>
                        <td>300 - 600€ (único pago)</td>
                    </tr>
                    <tr>
                        <td>Coste adicional por nóminas</td>
                        <td>Opcional</td>
                        <td>Opcional</td>
                        <td>+10-20€/empleado/mes</td>
                    </tr>
                    <tr>
                        <td class="font-bold">TOTAL aproximado mensual</td>
                        <td class="font-bold">110 - 180€</td>
                        <td class="font-bold">260 - 330€</td>
                        <td class="font-bold">410 - 700€</td>
                    </tr>
                </tbody>
            </table>
            <div class="text-right mt-6">
                <button class="btn btn-secondary" onclick="closeLegalFormModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        let currentBlock = 1;
        const totalBlocks = 7; // Now including the results block

        // Store collected form data
        let formData = {
            products: [] // Initialize products as an empty array
        };

        // Chart instances to destroy before re-rendering
        let breakEvenChartInstance, contributionMarginChartInstance, costDistributionChartInstance, operatingCostChartInstance, riskProfitabilityMatrixInstance;

        // Function to show a specific block and hide others
        function showBlock(blockNumber) {
            // Scroll to the top of the page
            window.scrollTo(0, 0);

            for (let i = 1; i <= totalBlocks; i++) {
                const block = document.getElementById(`block-${i}`);
                if (block) {
                    block.classList.add('hidden');
                }
            }
            const targetBlock = document.getElementById(`block-${blockNumber}`);
            if (targetBlock) {
                targetBlock.classList.remove('hidden');
            }
        }

        // Navigate to the next block
        function nextBlock() {
            if (currentBlock < totalBlocks) {
                currentBlock++;
                showBlock(currentBlock);
            } else if (currentBlock === totalBlocks -1) { // If it's the last form block (Block 6)
                submitForm();
            }
        }

        // Navigate to the previous block
        function prevBlock() {
            if (currentBlock > 1) {
                currentBlock--;
                showBlock(currentBlock);
            }
        }

        // Helper to check and fill an expense input
        function checkAndFillExpense(checkboxId, amountInputId, value) {
            const checkbox = document.getElementById(checkboxId);
            const amountInput = document.getElementById(amountInputId);
            if (checkbox && amountInput) {
                checkbox.checked = true;
                amountInput.value = value;
                amountInput.classList.remove('hidden');
            }
        }

        // Helper to uncheck and clear an expense input
        function uncheckAndClearExpense(checkboxId, amountInputId) {
            const checkbox = document.getElementById(checkboxId);
            const amountInput = document.getElementById(amountInputId);
            if (checkbox && amountInput) {
                checkbox.checked = false;
                amountInput.value = '';
                amountInput.classList.add('hidden');
            }
        }

        // Function to update legal form related costs in the UI
        function updateLegalFormCostsInUI() {
            // Clear all legal form related expenses first
            uncheckAndClearExpense('expConstitucion', 'expConstitucionAmount');
            uncheckAndClearExpense('monthlySeguridadSocial', 'monthlySeguridadSocialAmount');
            uncheckAndClearExpense('monthlyGestoria', 'monthlyGestoriaAmount');

            const legalForm = formData.legalForm;
            const autonomoType = formData.autonomoType;

            if (legalForm === 'autonomo') {
                checkAndFillExpense('expConstitucion', 'expConstitucionAmount', 0); // Autónomo: 0€ constitución
                checkAndFillExpense('monthlyGestoria', 'monthlyGestoriaAmount', 65); // Autónomo: 65€ gestoría (average)

                if (autonomoType === 'tarifa_plana') {
                    checkAndFillExpense('monthlySeguridadSocial', 'monthlySeguridadSocialAmount', 80); // Autónomo Tarifa Plana: 80€
                } else if (autonomoType === 'normal') {
                    checkAndFillExpense('monthlySeguridadSocial', 'monthlySeguridadSocialAmount', 230); // Autónomo Normal: 230€ (min)
                }
            } else if (legalForm === 'sl') {
                checkAndFillExpense('expConstitucion', 'expConstitucionAmount', 450); // SL: 450€ constitución (average)
                checkAndFillExpense('monthlySeguridadSocial', 'monthlySeguridadSocialAmount', 355); // SL: 355€ seguridad social (average)
                checkAndFillExpense('monthlyGestoria', 'monthlyGestoriaAmount', 200); // SL: 200€ gestoría (average)
            }
        }

        // Handle selection for button-like options
        function selectOption(button, groupName) {
            const buttonsInGroup = document.querySelectorAll(`[data-name="${groupName}"]`);
            buttonsInGroup.forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            // Store the selected value
            formData[groupName] = button.dataset.value;

            // NEW LOGIC: Conditional display for 'spaceTypeQuestion'
            if (groupName === 'needsSpace') {
                const spaceTypeQuestionDiv = document.getElementById('spaceTypeQuestion');
                const spaceTypeSelect = document.getElementById('spaceType');
                if (button.dataset.value === 'si') {
                    spaceTypeQuestionDiv.classList.remove('hidden');
                } else {
                    spaceTypeQuestionDiv.classList.add('hidden');
                    spaceTypeSelect.value = ''; // Clear the select value
                    formData.spaceType = ''; // Clear from formData
                }
            } else if (groupName === 'legalForm') {
                const autonomoTypeQuestionDiv = document.getElementById('autonomoTypeQuestion');
                if (button.dataset.value === 'autonomo') {
                    autonomoTypeQuestionDiv.classList.remove('hidden');
                } else {
                    autonomoTypeQuestionDiv.classList.add('hidden');
                    // Deselect autonomoType if SL is chosen
                    document.querySelectorAll('[data-name="autonomoType"]').forEach(btn => btn.classList.remove('selected'));
                    formData.autonomoType = '';
                }
            }
        }

        // Toggle visibility of expense amount input
        function toggleExpenseInput(checkbox, inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                if (checkbox.checked) {
                    input.classList.remove('hidden');
                    input.focus();
                } else {
                    input.classList.add('hidden');
                    input.value = ''; // Clear value when hidden
                }
            }
        }

        // Function to add a new custom expense input
        let customInitialExpenseCount = 0;
        let customMonthlyExpenseCount = 0;

        function addCustomExpense(containerId, expenseType) {
            const container = document.getElementById(containerId);
            const newExpenseItem = document.createElement('div');
            // Add a specific class for custom items to easily select them later
            newExpenseItem.className = 'custom-expense-item';

            let count;
            let placeholderTextName;
            let placeholderTextAmount = 'Cantidad (€)';

            if (expenseType === 'initial') {
                customInitialExpenseCount++;
                count = customInitialExpenseCount;
                placeholderTextName = 'Nombre del gasto inicial';
            } else { // monthly
                customMonthlyExpenseCount++;
                count = customMonthlyExpenseCount;
                placeholderTextName = 'Nombre del gasto mensual';
            }

            const nameInputId = `customExp${expenseType}_${count}_name`;
            const amountInputId = `customExp${expenseType}_${count}_amount`;

            newExpenseItem.innerHTML = `
                <input type="text" id="${nameInputId}" class="custom-expense-name-input" placeholder="${placeholderTextName}">
                <input type="number" id="${amountInputId}" class="custom-expense-amount-input" min="0" step="0.01" placeholder="${placeholderTextAmount}">
                <button type="button" class="remove-custom-expense-btn" onclick="removeCustomExpense(this)">X</button>
            `;
            container.appendChild(newExpenseItem);
        }

        // Function to remove a custom expense input
        function removeCustomExpense(button) {
            const item = button.closest('.custom-expense-item');
            if (item) {
                item.remove();
            }
        }


        // Add a new product/service entry
        function addProductEntry() {
            const container = document.getElementById('productsServicesContainer');
            const newEntry = document.createElement('div');
            newEntry.className = 'product-entry';
            const productCount = container.children.length + 1;
            newEntry.innerHTML = `
                <button type="button" class="remove-btn" onclick="removeProductEntry(this)">X</button>
                <h4 class="text-lg font-medium mb-4 text-gray-800">Producto/Servicio ${productCount}</h4>
                <div class="mb-4 tooltip-container">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Nombre del Producto/Servicio</label>
                    <input type="text" class="product-name" placeholder="Ej: Consultoría SEO">
                </div>
                <div class="mb-4 tooltip-container">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Precio medio de venta (€)</label>
                    <input type="number" class="product-avg-price" min="0" step="0.01" placeholder="Ej: 150.00">
                    <div class="info-icon">i<span class="tooltip-text">Precio promedio al que esperas vender cada unidad de tu producto o servicio.</span></div>
                </div>
                <div class="mb-4 tooltip-container">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Coste variable por unidad (€)</label>
                    <input type="number" class="product-variable-cost" min="0" step="0.01" placeholder="Ej: 30.00">
                    <div class="info-icon">i<span class="tooltip-text">Coste directo asociado a la producción o entrega de cada unidad vendida (ej. materiales, comisiones por venta).</span></div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Unidades esperadas a vender al mes</label>
                    <input type="number" class="product-units-per-month" min="0" placeholder="Ej: 10">
                </div>
            `;
            container.appendChild(newEntry);
        }

        // Remove a product/service entry
        function removeProductEntry(button) {
            const entry = button.closest('.product-entry');
            if (entry) {
                entry.remove();
                // Re-label remaining entries
                const container = document.getElementById('productsServicesContainer');
                Array.from(container.children).forEach((child, index) => {
                    const title = child.querySelector('h4');
                    if (title) {
                        title.textContent = `Producto/Servicio ${index + 1}`;
                    }
                });
            }
        }

        // Calculate total estimated monthly revenue for all products/services
        function calculateTotalRevenue() {
            let totalRevenue = 0;
            const productEntries = document.querySelectorAll('#productsServicesContainer .product-entry');
            productEntries.forEach(entry => {
                const avgPrice = parseFloat(entry.querySelector('.product-avg-price').value) || 0;
                const unitsPerMonth = parseFloat(entry.querySelector('.product-units-per-month').value) || 0;
                totalRevenue += avgPrice * unitsPerMonth;
            });
            document.getElementById('estimatedTotalRevenue').value = totalRevenue.toFixed(2);
        }

        // Function to collect all form data
        function collectFormData() {
            // Block 2
            formData.projectName = document.getElementById('projectName').value;
            formData.problemSolved = document.getElementById('problemSolved').value;
            formData.sector = document.getElementById('sector').value;
            // sellType and sellLocation are handled by selectOption
            formData.differentiation = document.getElementById('differentiation').value;

            // Block 3
            // needsSpace, hasEmployees, fundingSecured are handled by selectOption
            // spaceType is now conditionally handled by selectOption, but we ensure it's collected if visible
            const spaceTypeSelect = document.getElementById('spaceType');
            if (!spaceTypeSelect.closest('.hidden')) { // Only collect if visible
                formData.spaceType = spaceTypeSelect.value;
            } else {
                formData.spaceType = ''; // Ensure it's empty if hidden
            }

            formData.hoursPerDay = parseFloat(document.getElementById('hoursPerDay').value) || 0;
            formData.daysPerWeek = parseFloat(document.getElementById('daysPerWeek').value) || 0;
            formData.canDelegate = document.getElementById('canDelegate').value;

            // Block 4
            formData.initialInvestmentEstimate = document.getElementById('initialInvestment').value;
            formData.initialExpenses = {};
            formData.monthlyExpenses = {};

            // Collect pre-defined initial expenses
            document.querySelectorAll('#initialExpensesContainer .checkbox-item input[type="checkbox"]:checked').forEach(checkbox => {
                const amountInput = document.getElementById(checkbox.id + 'Amount');
                formData.initialExpenses[checkbox.value] = parseFloat(amountInput.value) || 0;
            });
            // Collect custom initial expenses
            document.querySelectorAll('#initialExpensesContainer .custom-expense-item').forEach(item => {
                const nameInput = item.querySelector('.custom-expense-name-input');
                const amountInput = item.querySelector('.custom-expense-amount-input');
                const expenseName = nameInput.value.trim();
                const expenseAmount = parseFloat(amountInput.value) || 0;
                if (expenseName && expenseAmount > 0) {
                    formData.initialExpenses[expenseName] = expenseAmount;
                }
            });

            // Collect pre-defined monthly expenses
            document.querySelectorAll('#monthlyExpensesContainer .checkbox-item input[type="checkbox"]:checked').forEach(checkbox => {
                const amountInput = document.getElementById(checkbox.id + 'Amount');
                formData.monthlyExpenses[checkbox.value] = parseFloat(amountInput.value) || 0;
            });
            // Collect custom monthly expenses
            document.querySelectorAll('#monthlyExpensesContainer .custom-expense-item').forEach(item => {
                const nameInput = item.querySelector('.custom-expense-name-input');
                const amountInput = item.querySelector('.custom-expense-amount-input');
                const expenseName = nameInput.value.trim();
                const expenseAmount = parseFloat(amountInput.value) || 0;
                if (expenseName && expenseAmount > 0) {
                    formData.monthlyExpenses[expenseName] = expenseAmount;
                }
            });

            console.log("Collected Form Data:", formData);
        }

        // Function to display results and generate charts
        function displayResults() {
            collectFormData(); // Ensure data is up-to-date

            // --- Calculations ---
            let totalInitialInvestment = 0;
            for (const key in formData.initialExpenses) {
                totalInitialInvestment += formData.initialExpenses[key];
            }

            let totalMonthlyFixedExpenses = 0;
            for (const key in formData.monthlyExpenses) {
                totalMonthlyFixedExpenses += formData.monthlyExpenses[key];
            }
            const totalAnnualFixedCosts = totalMonthlyFixedExpenses * 12;

            // Calculations for multiple products
            let totalEstimatedMonthlyRevenue = 0;
            let totalAnnualSalesVolumeUnits = 0;
            let totalMonthlyContributionMargin = 0;
            let weightedAverageUnitMargin = 0;
            let totalUnitsSoldMonthly = 0; // Renamed for clarity: monthly total units sold

            formData.products.forEach(product => {
                totalEstimatedMonthlyRevenue += product.estimatedMonthlyRevenue;
                totalAnnualSalesVolumeUnits += product.unitsPerMonth * 12; // This is ANNUAL total units sold
                totalMonthlyContributionMargin += (product.unitMargin * product.unitsPerMonth);
                totalUnitsSoldMonthly += product.unitsPerMonth;
            });

            if (totalUnitsSoldMonthly > 0) {
                weightedAverageUnitMargin = totalMonthlyContributionMargin / totalUnitsSoldMonthly;
            } else {
                weightedAverageUnitMargin = 0; // Avoid division by zero
            }

            // CORRECTED: Rentabilidad Anual Estimada (Beneficio Neto Anual)
            // This now correctly subtracts all costs (fixed and variable)
            const estimatedAnnualProfitability = (totalMonthlyContributionMargin * 12) - totalAnnualFixedCosts;


            let breakEvenUnits = 0;
            if (weightedAverageUnitMargin > 0) {
                breakEvenUnits = totalAnnualFixedCosts / weightedAverageUnitMargin;
            }
            const breakEvenRevenue = breakEvenUnits * (totalEstimatedMonthlyRevenue / (totalUnitsSoldMonthly || 1)); // Use average price if multiple products

            // --- ROI Calculation ---
            let roi = 0;
            if (totalInitialInvestment > 0) {
                roi = (estimatedAnnualProfitability / totalInitialInvestment) * 100;
            } else {
                roi = 'N/A'; // Handle division by zero
            }

            // --- Payback Period Calculation ---
            let paybackPeriod = '';
            if (totalInitialInvestment <= 0) {
                paybackPeriod = 'No aplica (sin inversión inicial)';
            } else if (estimatedAnnualProfitability <= 0) {
                paybackPeriod = 'No aplica (rentabilidad negativa o nula)';
            } else {
                // Format the number for Spanish locale with one decimal place
                const paybackYears = (totalInitialInvestment / estimatedAnnualProfitability).toLocaleString('es-ES', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
                paybackPeriod = `${paybackYears} años`;
            }


            // --- Risk and Viability Score (Basic Logic) ---
            let riskScore = formData.risks.length * 10; // Each risk adds 10 points
            if (formData.initialInvestmentEstimate === 'mas_20k') riskScore += 20;
            if (formData.fundingSecured === 'no') riskScore += 30;
            if (formData.projectStatus === 'solo_idea') riskScore += 15;

            let riskLevel = 'Bajo';
            let riskClass = 'risk-low';
            if (riskScore > 40) {
                riskLevel = 'Medio';
                riskClass = 'risk-medium';
            }
            if (riskScore > 70) {
                riskLevel = 'Alto';
                riskClass = 'risk-high';
            }

            let viabilityScore = 50; // Base score
            // Adjust viability score based on the CORRECTED estimatedAnnualProfitability
            if (estimatedAnnualProfitability > 0) {
                viabilityScore += Math.min(50, estimatedAnnualProfitability / 1000); // Max +50 for profitability
            } else {
                viabilityScore = Math.max(0, viabilityScore + (estimatedAnnualProfitability / 500)); // Penalize for negative profitability
            }

            if (weightedAverageUnitMargin > 0) viabilityScore += 10;
            if (formData.risks.length === 0) viabilityScore += 15;
            if (formData.projectStatus === 'clientes_ventas') viabilityScore += 20;
            if (formData.canDelegate === 'totalmente') viabilityScore += 10;
            if (formData.fundingSecured === 'si') viabilityScore += 15;

            viabilityScore = Math.max(0, Math.min(100, Math.round(viabilityScore))); // Cap between 0 and 100

            // --- Populate Results Section ---
            document.getElementById('resultProfitability').textContent = `${estimatedAnnualProfitability.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €`;
            document.getElementById('resultInitialInvestment').textContent = `${totalInitialInvestment.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €`;
            document.getElementById('resultAnnualFixedCosts').textContent = `${totalAnnualFixedCosts.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €`;
            document.getElementById('resultSalesVolume').textContent = `${totalAnnualSalesVolumeUnits.toLocaleString('es-ES', { maximumFractionDigits: 0 })} unidades`;
            document.getElementById('resultBreakEvenUnits').textContent = `${breakEvenUnits.toLocaleString('es-ES', { maximumFractionDigits: 0 })} unidades (${breakEvenRevenue.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €)`;
            document.getElementById('resultTotalContributionMargin').textContent = `${totalMonthlyContributionMargin.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €`; // Updated for total contribution
            document.getElementById('resultROI').textContent = (typeof roi === 'number' ? `${roi.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}%` : roi); // Display ROI
            document.getElementById('resultPaybackPeriod').textContent = paybackPeriod; // Display Payback Period
            const riskElement = document.getElementById('resultRisk');
            riskElement.textContent = riskLevel;
            riskElement.className = `risk-level ${riskClass}`; // Apply class for color
            document.getElementById('resultViabilityScore').textContent = `${viabilityScore.toLocaleString('es-ES', { maximumFractionDigits: 0 })}%`;

            // --- Observations ---
            let summaryText = `Tu proyecto "${formData.projectName || 'sin nombre'}" opera en el sector de ${formData.sector || 'no especificado'}. `;
            summaryText += `Se enfoca en ${formData.sellType || 'productos/servicios no definidos'} y planea vender ${formData.sellLocation || 'en un lugar no definido'}. `;
            summaryText += `Tu inversión inicial estimada es de ${totalInitialInvestment.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} € y tus gastos fijos mensuales ascienden a ${totalMonthlyFixedExpenses.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €. `;
            if (estimatedAnnualProfitability > 0) {
                summaryText += `La rentabilidad anual estimada es de ${estimatedAnnualProfitability.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €. `;
            } else {
                summaryText += `Tu proyecto tiene una pérdida anual estimada de ${Math.abs(estimatedAnnualProfitability).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €. `;
            }

            if (typeof roi === 'number') {
                summaryText += `El retorno de la inversión (ROI) estimado es del ${roi.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}%.`;
            } else {
                summaryText += `El retorno de la inversión (ROI) no aplica al no haber inversión inicial.`;
            }
            summaryText += ` El periodo de recuperación de la inversión (Payback) es de ${paybackPeriod}.`; // Added payback to summary
            summaryText += ` Consulta la matriz Riesgo vs. Rentabilidad para una visión visual de tu idea.`;


            let adviceText = "Consejo: ";
            if (viabilityScore >= 70) {
                adviceText += "¡Tu idea tiene un gran potencial! Enfócate en la ejecución y en validar tus supuestos de mercado. Considera buscar financiación para escalar rápidamente.";
            } else if (viabilityScore >= 40) {
                adviceText += "Tu idea es prometedora, pero hay áreas de mejora. Revisa tus costes, busca formas de aumentar tu margen unitario y valida la demanda con pruebas reales. Un plan de contingencia para los riesgos detectados es crucial.";
            } else {
                adviceText += "Tu idea necesita una revisión profunda. Te recomendamos reevaluar tu propuesta de valor, reducir drásticamente los costes o explorar un modelo de negocio diferente para mejorar la viabilidad. La financiación y la demanda son puntos críticos a resolver.";
            }

            if (formData.risks.length > 0) {
                adviceText += ` Riesgos detectados: ${formData.risks.join(', ')}.`;
            }
            if (formData.fundingSecured === 'no') {
                adviceText += " La financiación es un punto clave a asegurar.";
            } else if (formData.fundingSecured === 'no_se') {
                adviceText += " Es vital investigar las opciones de financiación.";
            }

            document.getElementById('observationsSummary').textContent = summaryText;
            document.getElementById('observationsAdvice').textContent = adviceText;

            // --- Destroy existing charts before creating new ones ---
            if (breakEvenChartInstance) breakEvenChartInstance.destroy();
            if (contributionMarginChartInstance) contributionMarginChartInstance.destroy();
            if (costDistributionChartInstance) costDistributionChartInstance.destroy();
            if (operatingCostChartInstance) operatingCostChartInstance.destroy();
            if (riskProfitabilityMatrixInstance) riskProfitabilityMatrixInstance.destroy(); // Destroy new chart instance

            // --- Generate Charts ---

            // Break-even Chart
            const ctxBreakEven = document.getElementById('breakEvenChart').getContext('2d');
            breakEvenChartInstance = new Chart(ctxBreakEven, {
                type: 'bar',
                data: {
                    labels: ['Unidades de Equilibrio (Anual)', 'Unidades Esperadas (Anual)'], // Updated labels
                    datasets: [{
                        label: 'Unidades',
                        data: [breakEvenUnits, totalAnnualSalesVolumeUnits], // Changed to totalAnnualSalesVolumeUnits
                        backgroundColor: ['rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)'],
                        borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Punto de Equilibrio Anual vs. Ventas Esperadas Anuales' // Updated title
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Unidades'
                            }
                        }
                    }
                }
            });

            // Contribution Margin Chart (for multiple products)
            const productNames = formData.products.map(p => p.name);
            const productUnitMargins = formData.products.map(p => p.unitMargin);
            const ctxContribution = document.getElementById('contributionMarginChart').getContext('2d');
            contributionMarginChartInstance = new Chart(ctxContribution, {
                type: 'bar',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: 'Margen Unitario (€)',
                        data: productUnitMargins,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Margen de Contribución por Producto/Servicio'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Euros (€)'
                            }
                        }
                    }
                }
            });

            // Cost Distribution Chart (Doughnut for Monthly Fixed Expenses)
            const monthlyExpenseLabels = Object.keys(formData.monthlyExpenses);
            const monthlyExpenseValues = Object.values(formData.monthlyExpenses);
            const ctxCostDistribution = document.getElementById('costDistributionChart').getContext('2d');
            costDistributionChartInstance = new Chart(ctxCostDistribution, {
                type: 'doughnut',
                data: {
                    labels: monthlyExpenseLabels,
                    datasets: [{
                        label: 'Gastos Mensuales',
                        data: monthlyExpenseValues,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)',
                            'rgba(255, 159, 64, 0.6)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribución de Gastos Fijos Mensuales'
                        },
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });

            // Operating Cost vs. Revenue Chart (Cost per Day)
            const totalAnnualOperatingDays = formData.daysPerWeek * 52; // Total annual operating days
            const dailyOperatingCost = totalAnnualFixedCosts / (totalAnnualOperatingDays || 1); // Avoid division by zero

            // Calculate annual revenue from estimated monthly revenue
            const totalAnnualRevenue = formData.estimatedTotalRevenue * 12;
            const dailyRevenue = totalAnnualRevenue / (totalAnnualOperatingDays || 1); // Avoid division by zero


            const ctxOperatingCost = document.getElementById('operatingCostChart').getContext('2d');
            operatingCostChartInstance = new Chart(ctxOperatingCost, {
                type: 'bar',
                data: {
                    labels: ['Diario'], // Only daily data
                    datasets: [
                        {
                            label: 'Coste Estimado (€)',
                            data: [dailyOperatingCost], // Only daily cost
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Ingreso Estimado (€)',
                            data: [dailyRevenue], // Only daily revenue
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Coste vs. Ingreso de Operación por Día' // Updated title
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            stacked: false, // Ensure bars are grouped, not stacked
                            title: {
                                display: true,
                                text: 'Período'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Euros (€)'
                            }
                        }
                    }
                }
            });

            // New: Risk vs. Profitability Matrix
            const ctxRiskProfitability = document.getElementById('riskProfitabilityMatrix').getContext('2d');
            riskProfitabilityMatrixInstance = new Chart(ctxRiskProfitability, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Tu Idea de Negocio',
                        data: [{
                            x: estimatedAnnualProfitability, // Rentabilidad Anual Estimada
                            y: riskScore // Puntuación de Riesgo
                        }],
                        backgroundColor: 'rgba(59, 130, 246, 0.8)', // Azul vibrante
                        borderColor: 'rgba(29, 78, 216, 1)',
                        borderWidth: 2,
                        pointRadius: 8, // Tamaño del punto
                        pointHoverRadius: 10,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Matriz Riesgo vs. Rentabilidad Anual'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Rentabilidad: ${context.parsed.x.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €, Riesgo: ${context.parsed.y.toFixed(0)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Rentabilidad Anual Estimada (€)'
                            },
                            grid: {
                                borderColor: '#e2e8f0',
                                color: '#e2e8f0',
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Puntuación de Riesgo'
                            },
                            grid: {
                                borderColor: '#e2e8f0',
                                color: '#e2e8f0',
                            }
                        }
                    }
                }
            });
        }

        // Function to handle form submission (e.g., collect data and display summary)
        function submitForm() {
            // Move to the results block
            currentBlock = totalBlocks;
            showBlock(currentBlock);
            displayResults(); // Call the function to calculate and display results
        }

        // Function to reset the form and go back to the welcome screen
        function resetForm() {
            // Clear all form fields
            document.getElementById('projectName').value = '';
            document.getElementById('problemSolved').value = '';
            document.getElementById('sector').value = '';
            document.getElementById('differentiation').value = '';
            document.getElementById('hoursPerDay').value = '';
            document.getElementById('daysPerWeek').value = '';
            document.getElementById('spaceType').value = ''; // Clear spaceType
            document.getElementById('initialInvestment').value = '';
            document.getElementById('estimatedTotalRevenue').value = ''; // Clear total revenue
            document.getElementById('projectStatus').value = '';

            // Deselect all option buttons
            document.querySelectorAll('.option-button.selected').forEach(btn => btn.classList.remove('selected'));

            // Uncheck all checkboxes and hide their inputs
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
                const inputId = checkbox.id + 'Amount';
                const input = document.getElementById(inputId);
                if (input) {
                    input.classList.add('hidden');
                    input.value = '';
                }
            });

            // Clear all product entries except the first one
            const productsContainer = document.getElementById('productsServicesContainer');
            while (productsContainer.children.length > 1) {
                productsContainer.removeChild(productsContainer.lastChild);
            }
            // Clear the first product entry's values
            const firstProductEntry = productsContainer.querySelector('.product-entry');
            if (firstProductEntry) {
                firstProductEntry.querySelector('.product-name').value = '';
                firstProductEntry.querySelector('.product-avg-price').value = '';
                firstProductEntry.querySelector('.product-variable-cost').value = '';
                firstProductEntry.querySelector('.product-units-per-month').value = '';
                firstProductEntry.querySelector('h4').textContent = 'Producto/Servicio 1'; // Reset title
            }

            // Hide conditional questions on reset
            document.getElementById('spaceTypeQuestion').classList.add('hidden');
            document.getElementById('autonomoTypeQuestion').classList.add('hidden');


            // Remove all custom expense items
            document.querySelectorAll('.custom-expense-item').forEach(item => item.remove());
            customInitialExpenseCount = 0;
            customMonthlyExpenseCount = 0;


            // Clear formData object
            formData = { products: [] }; // Reset products array

            // Destroy chart instances if they exist
            if (breakEvenChartInstance) breakEvenChartInstance.destroy();
            if (contributionMarginChartInstance) contributionMarginChartInstance.destroy();
            if (costDistributionChartInstance) costDistributionChartInstance.destroy();
            if (operatingCostChartInstance) operatingCostChartInstance.destroy();
            if (riskProfitabilityMatrixInstance) riskProfitabilityMatrixInstance.destroy(); // Destroy new chart instance

            currentBlock = 1;
            showBlock(currentBlock);
        }

        // Modal functions
        function openLegalFormModal() {
            document.getElementById('legalFormModal').classList.add('visible');
        }

        function closeLegalFormModal() {
            document.getElementById('legalFormModal').classList.remove('visible');
        }

        // Initial display: show only the first block on load
        document.addEventListener('DOMContentLoaded', () => {
            showBlock(currentBlock);
        });
    </script>
</body>
</html>
